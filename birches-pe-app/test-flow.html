<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Flow - Birch Tree Blueprint</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        button { padding: 10px 20px; margin: 10px 0; cursor: pointer; background: #007AFF; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üå≥ Birch Tree Blueprint - Test Flow</h1>
    
    <button onclick="testFullFlow()">Test Complete Flow</button>
    
    <div id="status"></div>
    <div id="log"></div>
    
    <script type="module">
        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            const log = document.getElementById('log');
            
            const entry = document.createElement('div');
            entry.className = 'log';
            entry.innerHTML = `<span class="${isError ? 'error' : 'success'}">${new Date().toLocaleTimeString()}</span> - ${message}`;
            log.appendChild(entry);
            
            status.innerHTML = `<p class="${isError ? 'error' : 'success'}">${message}</p>`;
            console.log(message);
        }
        
        window.testFullFlow = async function() {
            try {
                updateStatus('Starting full flow test...');
                
                // Step 1: Import modules
                updateStatus('Importing modules...');
                const { DeterministicGenerator } = await import('./src/lib/generator.ts');
                
                // Step 2: Create generator
                updateStatus('Creating generator instance...');
                const generator = new DeterministicGenerator();
                
                // Wait for data to load
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 3: Create test input
                const input = {
                    gradeLevel: 'K-2',
                    duration: 45,
                    environment: 'indoor',
                    standards: ['S1', 'S2'],
                    equipmentLevel: 'standard',
                    activityPreferences: {
                        teamBased: true,
                        competitive: false,
                        creative: true
                    }
                };
                
                updateStatus('Test input created: ' + JSON.stringify(input));
                
                // Step 4: Generate playbook
                updateStatus('Generating playbook...');
                const playbook = await generator.generate(input);
                
                if (!playbook) {
                    throw new Error('No playbook returned');
                }
                
                updateStatus(`‚úÖ Playbook generated! ID: ${playbook.id}`);
                updateStatus(`Title: ${playbook.title}`);
                updateStatus(`Lessons: ${playbook.lessons.length}`);
                
                // Step 5: Store in sessionStorage
                updateStatus('Storing in sessionStorage...');
                const data = {
                    playbook: playbook,
                    userInput: input
                };
                sessionStorage.setItem('currentPlaybook', JSON.stringify(data));
                
                // Step 6: Verify storage
                const stored = sessionStorage.getItem('currentPlaybook');
                if (!stored) {
                    throw new Error('Failed to store in sessionStorage');
                }
                
                updateStatus('‚úÖ Successfully stored in sessionStorage!');
                
                // Step 7: Create link to playbook page
                const link = document.createElement('a');
                link.href = '/playbook.html';
                link.target = '_blank';
                link.textContent = '‚Üí Click here to view the generated playbook';
                link.style.display = 'block';
                link.style.marginTop = '20px';
                link.style.fontSize = '18px';
                document.getElementById('status').appendChild(link);
                
                updateStatus('‚úÖ Full flow test complete! Everything works!');
                
            } catch (error) {
                updateStatus(`‚ùå Error: ${error.message}`, true);
                console.error(error);
            }
        }
    </script>
</body>
</html>